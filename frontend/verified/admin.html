<html>
<header>
    <title>Admin</title>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <link rel='stylesheet' href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css"/>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/md5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
    <style>
        h1{
            padding-top: 20px;
            text-align: center;
            font-weight: bolder;
            font-family:monospace;
            font-size: 40px;
            color: black;
        }
        table{
            padding:20px;
        }
        th{
            color:black;
        }
        .form-popup {
            display: none;
            position: fixed;
            bottom: 0;
            right: 15px;
            border: 3px solid #f1f1f1;
            z-index: 9;
        }
    </style>
    
</header>

<body>
    <div>
        <h1>Admin Service</h1>
        <table id="personTableFull" class="cell-border compact stripe hover order-column">
            <thead>
                <tr>
                    <th>USERNAME</th>
                    <th>NAME</th>
                    <th>PHONE</th>
                    <th>PASSWORD</th>
                    <th>VALID</th>
                    <th>ROLES</th>
                </tr>
            </thead> 
        </table>
    </div>
    
    <div>
        <input type="button" id="add" value="Update" onclick="openupdate()"></input>
        <input type="button" id="update" value="Add" onclick="openadd()"></input>
        <input type="button" id="add" value="Delete" onclick="opendelete()"></input>
    </div>
    
    <div class="form-popup" id="updateform">
        <form class="form-container">
            <h1>Update user</h1>
            
            <input type="text" class="inputfield" id="add_username" placeholder="Enter Username" required>
            <input type="text" class="inputfield" id="add_name" placeholder="Enter Name" required>
            <input type="text" class="inputfield" id="add_phone" placeholder="Enter Phone number" required>
            <input type="password" class="inputfield" id="add_password" placeholder="Enter Password" required>
            <label><input type="checkbox" class="inputfield" id="add_valid" value="">Option 1</label>
            <label><input type="checkbox" class="inputfield" id="add_adminrole" value="">Option 1</label>
            <label><input type="checkbox" class="inputfield" id="add_userrole" placeholder="isUser" value="">Option 1</label>   
            <input type="button" value="put" onclick="update()"></input>
            <input type="button" value="close" onclick="closeupdate()"></input>
        </form>
    </div>
    
    <div class="form-popup" id="addform">
        <form class="form-container">
            <h1>Add user</h1>
            
            <input type="text" class="inputfield" id="add_username" placeholder="Enter Username" required>
            <input type="text" class="inputfield" id="add_name" placeholder="Enter Name" required>
            <input type="text" class="inputfield" id="add_phone" placeholder="Enter Phone number" required>
            <input type="password" class="inputfield" id="add_password" placeholder="Enter Password" required>
            <label><input type="checkbox" class="inputfield" id="add_valid" value="">Option 1</label>
            <label><input type="checkbox" class="inputfield" id="add_adminrole" value="">Option 1</label>
            <label><input type="checkbox" class="inputfield" id="add_userrole" placeholder="isUser" value="">Option 1</label>
            <input type="button" value="post" onclick="add()"></input>
            <input type="button" value="close" onclick="closeadd()"></input>
        </form>
    </div>
    
    <div class="form-popup" id="deleteform">
        <form class="form-container">
            <h1>Delete user</h1>
            
            <input type="text" class="inputfield" id="delete_username" placeholder="Enter Username" required>
            <input type="button" value="delete" onclick="del()"></input>
            <input type="button" value="close" onclick="closedelete()"></input>
        </form>
    </div>
    
</body>

<script>
    let refresh_success;
    function refresh(){
        console.log('refresh called');
        $.ajax({'url':"http://10.167.80.144/auth/refresh",'type': "POST",
        'data': JSON.stringify({refresh_token:Cookies.get('refresh_token')}),
        'contentType':"application/json",dataType: "json",
        success: function (response) {
            Cookies.set('access_token',response.access_token,{expires:(response.expiry/86400000)});
            refresh_success=true;
        },
        error: function (xhr, status){
            refresh_success=false;
        }});
    }
    
    var table=$('#personTableFull');
    $(document).ready( function () {
        function initiate(){
            $.ajax({'url':"http://10.167.80.144/user",'type': "GET",
            'contentType':"application/json",dataType: "json",
            success: function (response) {
                table.DataTable({
                    data: response, 
                    columns: [
                    {"data":"username"},
                    {"data":"name"},
                    {"data":"phone"},
                    {"data":"password"},
                    {"data":"valid"},
                    {"data":"roles"}
                    ]
                });
            },
            error: function (xhr, status){
                refresh();
                if(refresh_success){
                    console.log("Token was refreshed");
                    initiate();
                }
                else{
                    console.log("Token was not refreshed");
                }
            }});
        };
        initiate();
    });//end of initate
    
    function openadd(){
        closeupdate();
        closedelete();
        document.getElementById("addform").style.display = "block";
    }
    function closeadd(){
        document.getElementById("addform").style.display = "none";
    }
    function add(){
        let this_role=[];
        if($('#add_adminrole').val()){
            this_role.push("ROLE_ADMIN");
        }
        if($('#add_userrole').val()){
            this_role.push("ROLE_USER");
        }
        $.ajax({url:"http://10.167.80.144/user",'type': "POST",
        data:JSON.stringify({
            username:$('#add_username').val(),
            name:$('#add_name').val(),
            phone:$('#add_phone').val(),
            password:CryptoJS.MD5($('#add_password').val()).toString(CryptoJS.enc.Base64),
            valid:$('#add_valid').val(),
            role:this_role.toString()}),
            'contentType':"application/json",
            dataType: "json",
            success: function (response){
                console.log(respone);
            },
            error: function (xhr, status){
                refresh();
                if(refresh_success){
                    console.log("Token was refreshed");
                    add();
                }
                else{
                    console.log("Token was not refreshed");
                }
            }});
            
            table.DataTable().row.add({
                "username":$('#add_username').val(),
                "name":$('#add_name').val(),
                "phone":$('#add_phone').val(),
                "password":CryptoJS.MD5($('#add_password').val()).toString(CryptoJS.enc.Base64),
                "valid":$('#add_valid').val(),
                "roles":this_role.toString()}).draw();
                
                closeadd();
                
            }//end of add
            
            function openupdate(){
                closeadd();
                closedelete();
                document.getElementById("updateform").style.display = "block";
            }
            function closeupdate(){
                document.getElementById("updateform").style.display = "none";
            }
            function update(){
                let this_role=[];
                if($('#add_adminrole').val()){
                    this_role.push("ROLE_ADMIN");
                }
                if($('#add_userrole').val()){
                    this_role.push("ROLE_USER");
                }
                $.ajax({url:"http://10.167.80.144/user",'type': "PUT",
                data:JSON.stringify({
                    username:$('#add_username').val(),
                    name:$('#add_name').val(),
                    phone:$('#add_phone').val(),
                    password:CryptoJS.MD5($('#add_password').val()).toString(CryptoJS.enc.Base64),
                    valid:$('#add_valid').val(),
                    role:this_role.toString()}),
                    'contentType':"application/json",
                    dataType: "json",
                    success: function (response){
                        console.log(respone);
                    },
                    error: function (xhr, status){
                        refresh();
                        if(refresh_success){
                            console.log("Token was refreshed");
                            add();
                        }
                        else{
                            console.log("Token was not refreshed");
                        }
                    }});
                    initiate();
                    closeupdate();
                    //https://stackoverflow.com/questions/38392464/how-to-find-a-specific-row-by-values-in-jquery-datatables
                }
                
                function opendelete(){
                    closeadd();
                    closeupdate();
                    document.getElementById("deleteform").style.display = "block";
                }
                function closedelete(){
                    document.getElementById("deleteform").style.display = "none";
                }
                function del(){
                    $.ajax({url:"http://10.167.80.144/user/"+$('#delete_username').val(),'type':"DELETE",
                    success: function (response){
                        var resp = response;
                        console.log(resp);
                    },
                    error: function (xhr, status){
                        refresh();
                        if(refresh_success){
                            console.log("Token was refreshed");
                            del();
                        }
                        else{
                            console.log("Token was not refreshed");
                        }
                    }});
                    closedelete();
                    initiate();
                    //https://stackoverflow.com/questions/38392464/how-to-find-a-specific-row-by-values-in-jquery-datatables
                }
                
            </script>
            </html>
            